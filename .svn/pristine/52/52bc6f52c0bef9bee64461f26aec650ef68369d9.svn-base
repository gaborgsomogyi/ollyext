#include "stdafx.h"
#include "..\OllyExtProtect.h"
#include "ForceFlags.h"


#define PROCESS_HEAP_OFFSET ( 0x18 )
#define HEAP_FLAGS_OFFSET ( 0x40 )
#define HEAP_FORCE_FLAGS_OFFSET ( 0x44 )


static bool g_applied = false;
static BYTE g_patch1[] = { 0x02, 0x00, 0x00, 0x00 };
static BYTE g_orig1[sizeof( g_patch1 )] = { 0 };
static BYTE g_patch2[] = { 0x00, 0x00, 0x00, 0x00 };
static BYTE g_orig2[sizeof( g_patch2 )] = { 0 };


void forceFlagsReset( void )
{
	g_applied = false;
}


void forceFlagsApply( bool protect )
{
	if( protect )
	{
		if( g_applied ) return;

		DWORD processHeapAddress = peblock + PROCESS_HEAP_OFFSET;
		DWORD processHeap = 0;
		BOOL readSuccess = ReadProcessMemory( process, (void*)processHeapAddress, &processHeap, sizeof( processHeap ), NULL );
		PLUGIN_CHECK_ERROR( readSuccess, return, UNABLE_TO_READ_MEMORY_AT, processHeapAddress );

		if( !protectApplyPatch( (void*)( processHeap + HEAP_FLAGS_OFFSET ), g_orig1, g_patch1, sizeof( g_patch1 ) ) )
			return;
		if( !protectApplyPatch( (void*)( processHeap + HEAP_FORCE_FLAGS_OFFSET ), g_orig2, g_patch2, sizeof( g_patch2 ) ) )
			return;

		g_applied = true;
	}
	else
	{
		if( !g_applied ) return;

		DWORD processHeapAddress = peblock + PROCESS_HEAP_OFFSET;
		DWORD processHeap = 0;
		BOOL readSuccess = ReadProcessMemory( process, (void*)processHeapAddress, &processHeap, sizeof( processHeap ), NULL );
		PLUGIN_CHECK_ERROR( readSuccess, return, UNABLE_TO_READ_MEMORY_AT, processHeapAddress );

		if( !protectRevertPatch( (void*)( processHeap + HEAP_FLAGS_OFFSET ), g_orig1, sizeof( g_orig1 ) ) )
			return;
		if( !protectRevertPatch( (void*)( processHeap + HEAP_FORCE_FLAGS_OFFSET ), g_orig2, sizeof( g_orig2 ) ) )
			return;

		g_applied = false;
	}
}
