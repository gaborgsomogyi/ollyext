#include "stdafx.h"
#include "OllyExtProtect.h"

#include "IsDebuggerPresent.h"
#include "NtGlobalFlag.h"
#include "HeapFlags.h"
#include "ForceFlags.h"
#include "NtQueryInformationProcess.h"
#include "OutputDebugStringA.h"
#include "OutputDebugStringW.h"
#include "CloseHandle.h"
#include "SeDebugPrivilege.h"
#include "BlockInput.h"
#include "TerminateProcess.h"
#include "SetInformationThread.h"
#include "NtQueryObject.h"


sProtectOptions g_protectOptions = { 0 };


#define ISDEBUGGERPRESENT L"IsDebuggerPresent"
#define NTGLOBALFLAG L"NtGlobalFlag"
#define HEAPFLAGS L"HeapFlags"
#define FORCEFLAGS L"ForceFlags"
#define CHECKREMOTEDEBUGGERPRESENT L"CheckRemoteDebuggerPresent"
#define OUTPUTDEBUGSTRING L"OutputDebugString"
#define CLOSEHANDLE L"CloseHandle"
#define SEDEBUGPRIVILEGE L"SeDebugPrivilege"
#define BLOCKINPUT L"BlockInput"
#define PROCESSDEBUGFLAGS L"ProcessDebugFlags"
#define PROCESSDEBUGOBJECTHANDLE L"ProcessDebugObjectHandle"
#define TERMINATEPROCESS L"TerminateProcess"
#define SETINFORMATIONTHREAD L"SetInformationThread"
#define NTQUERYOBJECT L"NtQueryObject"

#define GETFROMINI( feature, option ) \
{ \
	DWORD data = 0; \
	Getfromini( NULL, PLUGIN_NAME, feature, L"%d", &data );\
	option = ( data != 0 ); \
}


void protectReadOptions( void )
{
	GETFROMINI( ISDEBUGGERPRESENT, g_protectOptions.isDebuggerPresent );
	GETFROMINI( NTGLOBALFLAG, g_protectOptions.ntGlobalFlag );
	GETFROMINI( HEAPFLAGS, g_protectOptions.heapFlags );
	GETFROMINI( FORCEFLAGS, g_protectOptions.forceFlags );
	GETFROMINI( CHECKREMOTEDEBUGGERPRESENT, g_protectOptions.checkRemoteDebuggerPresent );
	GETFROMINI( OUTPUTDEBUGSTRING, g_protectOptions.outputDebugString );
	GETFROMINI( CLOSEHANDLE, g_protectOptions.closeHandle );
	GETFROMINI( SEDEBUGPRIVILEGE, g_protectOptions.seDebugPrivilege );
	GETFROMINI( BLOCKINPUT, g_protectOptions.blockInput );
	GETFROMINI( PROCESSDEBUGFLAGS, g_protectOptions.processDebugFlags );
	GETFROMINI( PROCESSDEBUGOBJECTHANDLE, g_protectOptions.processDebugObjectHandle );
	GETFROMINI( TERMINATEPROCESS, g_protectOptions.terminateProcess );
	GETFROMINI( SETINFORMATIONTHREAD, g_protectOptions.setInformationThread );
	GETFROMINI( NTQUERYOBJECT, g_protectOptions.ntQueryObject );
}


void protectWriteOptions( void )
{
	Writetoini( NULL, PLUGIN_NAME, ISDEBUGGERPRESENT, L"%d", g_protectOptions.isDebuggerPresent );
	Writetoini( NULL, PLUGIN_NAME, NTGLOBALFLAG, L"%d", g_protectOptions.ntGlobalFlag );
	Writetoini( NULL, PLUGIN_NAME, HEAPFLAGS, L"%d", g_protectOptions.heapFlags );
	Writetoini( NULL, PLUGIN_NAME, FORCEFLAGS, L"%d", g_protectOptions.forceFlags );
	Writetoini( NULL, PLUGIN_NAME, CHECKREMOTEDEBUGGERPRESENT, L"%d", g_protectOptions.checkRemoteDebuggerPresent );
	Writetoini( NULL, PLUGIN_NAME, OUTPUTDEBUGSTRING, L"%d", g_protectOptions.outputDebugString );
	Writetoini( NULL, PLUGIN_NAME, CLOSEHANDLE, L"%d", g_protectOptions.closeHandle );
	Writetoini( NULL, PLUGIN_NAME, SEDEBUGPRIVILEGE, L"%d", g_protectOptions.seDebugPrivilege );
	Writetoini( NULL, PLUGIN_NAME, BLOCKINPUT, L"%d", g_protectOptions.blockInput );
	Writetoini( NULL, PLUGIN_NAME, PROCESSDEBUGFLAGS, L"%d", g_protectOptions.processDebugFlags );
	Writetoini( NULL, PLUGIN_NAME, PROCESSDEBUGOBJECTHANDLE, L"%d", g_protectOptions.processDebugObjectHandle );
	Writetoini( NULL, PLUGIN_NAME, TERMINATEPROCESS, L"%d", g_protectOptions.terminateProcess );
	Writetoini( NULL, PLUGIN_NAME, SETINFORMATIONTHREAD, L"%d", g_protectOptions.setInformationThread );
	Writetoini( NULL, PLUGIN_NAME, NTQUERYOBJECT, L"%d", g_protectOptions.ntQueryObject );
}


void protectReset( void )
{
	isDebuggerPresentReset();
	ntGlobalFlagReset();
	heapFlagsReset();
	forceFlagsReset();
	ntQueryInformationProcessReset();
	outputDebugStringAReset();
	outputDebugStringWReset();
	closeHandleReset();
	seDebugPrivilegeReset();
	blockInputReset();
	terminateProcessReset();
	setInformationThreadReset();
	ntQueryObjectReset();
}


bool protectApply( void )
{
	PLUGIN_CHECK_ERROR( process, return false;, NO_DEBUGGE );

	isDebuggerPresentApply( g_protectOptions.isDebuggerPresent );
	ntGlobalFlagApply( g_protectOptions.ntGlobalFlag );
	heapFlagsApply( g_protectOptions.heapFlags );
	forceFlagsApply( g_protectOptions.forceFlags );
	ntQueryInformationProcessApply
	(
		g_protectOptions.checkRemoteDebuggerPresent,
		g_protectOptions.processDebugFlags,
		g_protectOptions.processDebugObjectHandle
	);
	outputDebugStringAApply( g_protectOptions.outputDebugString );
	outputDebugStringWApply( g_protectOptions.outputDebugString );
	closeHandleApply( g_protectOptions.closeHandle );
	seDebugPrivilegeApply( g_protectOptions.seDebugPrivilege );
	blockInputApply( g_protectOptions.blockInput );
	terminateProcessApply( g_protectOptions.terminateProcess );
	setInformationThreadApply( g_protectOptions.setInformationThread );
	ntQueryObjectApply( g_protectOptions.ntQueryObject );

	Redrawcpudisasm();

	return true;
}
