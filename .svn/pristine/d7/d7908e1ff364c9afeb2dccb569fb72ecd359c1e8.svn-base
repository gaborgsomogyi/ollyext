.686P
.XMM
.MODEL	flat, stdcall

INCLUDELIB LIBCMT
INCLUDELIB OLDNAMES

.code

nopCmd proc
	nop
	ret
nopCmd endp

rdtscCmd proc edxOutput : dword, eaxOutput : dword
	push	eax
	push	ebx
	push	edx
	rdtsc
	mov		ebx, edxOutput
	mov		dword ptr [ebx], edx
	mov		ebx, eaxOutput
	mov		dword ptr [ebx], eax
	pop		edx
	push	ebx
	pop		eax
	ret
rdtscCmd endp

loadIDT proc address : dword
	push	eax
	mov		eax, [address]
	sidt	[eax]
	pop		eax
	ret		4
loadIDT endp

; returns the old cr0
writeEnable proc
	mov		eax, cr0
	push	eax
	and		eax, not 00010000h	;clear WP bit
	mov		cr0, eax
	pop		eax
	ret
writeEnable endp

; returns the old cr0
writeDisable proc
	mov		eax, cr0
	push	eax
	or		eax, 00010000h	;set WP bit
	mov		cr0, eax
	pop		eax
	ret
writeDisable endp

; returns the old cr4
RDTSCEnable proc
	mov		eax, cr4
	push	eax
	and		eax, not 00000004h	;clear TSD bit
	mov		cr4, eax
	pop		eax
	ret
RDTSCEnable endp

; returns the old cr4
RDTSCDisable proc
	mov		eax, cr4
	push	eax
	or		eax, 00000004h	;set TSD bit
	mov		cr4, eax
	pop		eax
	ret
RDTSCDisable endp

cliCmd proc
	cli
	ret
cliCmd endp

stiCmd proc
	sti
	ret
stiCmd endp

cltCmd proc
	pushfd;
	and byte ptr[esp + 1], 0feh;
	popfd;
	ret
cltCmd endp

sttCmd proc
	pushfd;
	or byte ptr[esp + 1], 1;
	popfd;
	ret
sttCmd endp

end
