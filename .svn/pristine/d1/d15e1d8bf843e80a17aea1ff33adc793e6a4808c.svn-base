#include "stdafx.h"
#include "DbgExtOS.h"


struct OSDETECTEDVERSION
{
	wchar_t* osName;

	// ntdll->_PEB->BeingDebugged
	DWORD BeingDebugged;

	// ntdll->_PEB->ProcessHeaps
	DWORD ProcessHeaps;

	// ntdll->_PEB->NtGlobalFlag
	DWORD NtGlobalFlag;

	// ntdll->_HEAP->Flags
	DWORD Flags;

	// ntdll->_HEAP->ForceFlags
	DWORD ForceFlags;
};

struct OSVERSIONINFOEX_
{
    DWORD dwMajorVersion;
    DWORD dwMinorVersion;
	WORD wServicePackMajor;
	BYTE wProductType;

	OSDETECTEDVERSION detectedVersion;
};


const OSVERSIONINFOEX_ g_windowsVersions[] =
{
	{ 5, 1, 0, 0, { L"XP", 0x00000002, 0x00000018, 0x00000068, 0x0000000C, 0x00000010 } },
	{ 5, 1, 1, 0, { L"XP SP1", 0x00000002, 0x00000018, 0x00000068, 0x0000000C, 0x00000010 } },
	{ 5, 1, 2, 0, { L"XP SP2", 0x00000002, 0x00000018, 0x00000068, 0x0000000C, 0x00000010 } },
	{ 5, 1, 3, 0, { L"XP SP3", 0x00000002, 0x00000018, 0x00000068, 0x0000000C, 0x00000010 } },

//	{ 5, 2, 0, 0 }, // Server 2003
	{ 5, 2, 1, 0, { L"Server 2003 SP1", 0x00000002, 0x00000018, 0x00000068, 0x0000000C, 0x00000010 } },
	{ 5, 2, 2, 0, { L"Server 2003 SP2", 0x00000002, 0x00000018, 0x00000068, 0x0000000C, 0x00000010 } },

//	{ 6, 0, 0, VER_NT_WORKSTATION }, // Vista
//	{ 6, 0, 1, VER_NT_WORKSTATION }, // Vista SP1
//	{ 6, 0, 2, VER_NT_WORKSTATION }, // Vista SP2

//	{ 6, 0, 0, VER_NT_SERVER }, // Server 2008
//	{ 6, 0, 1, VER_NT_SERVER }, // Server 2008 SP1
//	{ 6, 0, 2, VER_NT_SERVER }, // Server 2008 SP1

	{ 6, 1, 0, VER_NT_SERVER, { L"Server 2008 R2", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },
	{ 6, 1, 1, VER_NT_SERVER, { L"Server 2008 R2 SP1", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },

	{ 6, 1, 0, VER_NT_WORKSTATION, { L"7", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },
	{ 6, 1, 1, VER_NT_WORKSTATION, { L"7 SP1", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },

	{ 6, 2, 0, VER_NT_SERVER, { L"Server 2012", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },
	{ 6, 2, 0, VER_NT_WORKSTATION, { L"8", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },

	{ 6, 3, 0, VER_NT_SERVER, { L"Server 2012 R2", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },
	{ 6, 3, 0, VER_NT_WORKSTATION, { L"8.1", 0x00000002, 0x00000018, 0x00000068, 0x00000040, 0x00000044 } },
};


static OSVERSIONINFOEX_ g_osVersion = { 0, 0, 0, 0, { L"UNKNOWN", 0x00000000, 0x00000000, 0x00000000, 0x00000000 } };


static BOOL osEqualsMajorVersion( DWORD majorVersion )
{
    OSVERSIONINFOEX osVersionInfo;
    ZeroMemory( &osVersionInfo, sizeof( OSVERSIONINFOEX ) );
    osVersionInfo.dwOSVersionInfoSize = sizeof( OSVERSIONINFOEX );
    osVersionInfo.dwMajorVersion = majorVersion;
    ULONGLONG maskCondition = VerSetConditionMask( 0, VER_MAJORVERSION, VER_EQUAL );
    return VerifyVersionInfo( &osVersionInfo, VER_MAJORVERSION, maskCondition );
}


static BOOL osEqualsMinorVersion( DWORD minorVersion )
{
    OSVERSIONINFOEX osVersionInfo;
    ZeroMemory( &osVersionInfo, sizeof( OSVERSIONINFOEX ) );
    osVersionInfo.dwOSVersionInfoSize = sizeof( OSVERSIONINFOEX );
    osVersionInfo.dwMinorVersion = minorVersion;
    ULONGLONG maskCondition = VerSetConditionMask( 0, VER_MINORVERSION, VER_EQUAL );
    return VerifyVersionInfo( &osVersionInfo, VER_MINORVERSION, maskCondition );
}


static BOOL osEqualsServicePack( WORD servicePackMajor )
{
    OSVERSIONINFOEX osVersionInfo;
    ZeroMemory( &osVersionInfo, sizeof( OSVERSIONINFOEX ) );
    osVersionInfo.dwOSVersionInfoSize = sizeof( OSVERSIONINFOEX );
    osVersionInfo.wServicePackMajor = servicePackMajor;
    ULONGLONG maskCondition = VerSetConditionMask( 0, VER_SERVICEPACKMAJOR, VER_EQUAL );
    return VerifyVersionInfo( &osVersionInfo, VER_SERVICEPACKMAJOR, maskCondition );
}


static BOOL osEqualsProductType( BYTE productType )
{
    OSVERSIONINFOEX osVersionInfo;
    ZeroMemory( &osVersionInfo, sizeof( OSVERSIONINFOEX ) );
    osVersionInfo.dwOSVersionInfoSize = sizeof( OSVERSIONINFOEX );
    osVersionInfo.wProductType = productType;
    ULONGLONG maskCondition = VerSetConditionMask( 0, VER_PRODUCT_TYPE, VER_EQUAL );
    return VerifyVersionInfo( &osVersionInfo, VER_PRODUCT_TYPE, maskCondition );
}


static BYTE osGetProductType( void )
{
    if( osEqualsProductType( VER_NT_WORKSTATION ) )
    {
        return VER_NT_WORKSTATION;
    }
    else if( osEqualsProductType( VER_NT_DOMAIN_CONTROLLER ) )
    {
        return VER_NT_DOMAIN_CONTROLLER;
    }
    else if( osEqualsProductType( VER_NT_SERVER ) )
    {
        return VER_NT_SERVER;
    }
    return 0;
}


static BOOL GetVersionEx_( OSVERSIONINFOEX_& rOSVersionInfoEx )
{
	WORD wProductType = osGetProductType();

	for( DWORD i = 0; i < sizeof( g_windowsVersions ) / sizeof( OSVERSIONINFOEX_ ); ++i )
	{
		if( osEqualsMajorVersion( g_windowsVersions[i].dwMajorVersion ) )
		{
			if( osEqualsMinorVersion( g_windowsVersions[i].dwMinorVersion ) )
			{
				if( osEqualsServicePack( g_windowsVersions[i].wServicePackMajor ) )
				{
					if( !g_windowsVersions[i].wProductType || g_windowsVersions[i].wProductType == wProductType )
					{
						rOSVersionInfoEx.dwMajorVersion = g_windowsVersions[i].dwMajorVersion;
						rOSVersionInfoEx.dwMinorVersion = g_windowsVersions[i].dwMinorVersion;
						rOSVersionInfoEx.wServicePackMajor = g_windowsVersions[i].wServicePackMajor;

						rOSVersionInfoEx.detectedVersion = g_windowsVersions[i].detectedVersion;

						return TRUE;
					}
				}
			}
		}
	}
	return FALSE;
}


void osInit( void )
{
	OSVERSIONINFOEX_ osvi;

	// Get the Windows version.
	ZeroMemory( &osvi, sizeof( osvi ) );
	if( !GetVersionEx_( osvi ) )
	{
		Addtolist( 0, BLACK, L"OllyExt: This version considered as UNKNOWN" );
		MessageBox( NULL, UNABLE_TO_GET_WIN_VERSION, PLUGIN_NAME, MB_OK | MB_ICONERROR );
		return;
	}

	g_osVersion = osvi;

	if( !g_osVersion.wServicePackMajor )
	{
		Addtolist( 0, BLACK, L"OllyExt: Detected windows version: %d.%d No Service Pack",
					g_osVersion.dwMajorVersion,
					g_osVersion.dwMinorVersion );
	}
	else
	{
		Addtolist( 0, BLACK, L"OllyExt: Detected windows version: %d.%d Service Pack %d",
					g_osVersion.dwMajorVersion,
					g_osVersion.dwMinorVersion,
					g_osVersion.wServicePackMajor );
	}

	Addtolist( 0, BLACK, L"OllyExt: This version considered as Windows %s", g_osVersion.detectedVersion.osName );

	Addtolist( 0, BLACK, L"OllyExt: BeingDebugged offset: %08X", g_osVersion.detectedVersion.BeingDebugged );
	Addtolist( 0, BLACK, L"OllyExt: ProcessHeaps offset: %08X", g_osVersion.detectedVersion.ProcessHeaps );
	Addtolist( 0, BLACK, L"OllyExt: NtGlobalFlag offset: %08X", g_osVersion.detectedVersion.NtGlobalFlag );
	Addtolist( 0, BLACK, L"OllyExt: Flags offset: %08X", g_osVersion.detectedVersion.Flags );
	Addtolist( 0, BLACK, L"OllyExt: ForceFlags offset: %08X", g_osVersion.detectedVersion.ForceFlags );
}


void osDestroy( void )
{
}


// ntdll->_PEB->BeingDebugged
DWORD osGetBeingDebuggedOffset( void )
{
	return g_osVersion.detectedVersion.BeingDebugged;
}


// ntdll->_PEB->ProcessHeaps
DWORD osGetProcessHeapsOffset( void )
{
	return g_osVersion.detectedVersion.ProcessHeaps;
}


// ntdll->_PEB->NtGlobalFlag
DWORD osGetNtGlobalFlagOffset( void )
{
	return g_osVersion.detectedVersion.NtGlobalFlag;
}


// ntdll->_HEAP->Flags
DWORD osGetFlagsOffset( void )
{
	return g_osVersion.detectedVersion.Flags;
}


// ntdll->_HEAP->ForceFlags
DWORD osGetForceFlagsOffset( void )
{
	return g_osVersion.detectedVersion.ForceFlags;
}
