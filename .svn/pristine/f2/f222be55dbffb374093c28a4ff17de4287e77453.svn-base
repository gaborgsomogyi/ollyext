#include "stdafx.h"
#include "OllyExtRip.h"


void ripExecute( void )
{
	std::string s = "OllyExt ASM :)";

	PLUGIN_CHECK_ERROR( OpenClipboard( NULL ), return;, UNABLE_TO_OPEN_CLIPBOARD );

	PLUGIN_CHECK_ERROR( EmptyClipboard(),
		CloseClipboard();
		return;,
		UNABLE_TO_CLEAR_CLIPBOARD );

	HGLOBAL clipBuffer = GlobalAlloc( GMEM_DDESHARE, s.length() + 1 );
	PLUGIN_CHECK_ERROR( clipBuffer,
		CloseClipboard();
		return;,
		UNABLE_TO_ALLOCATE_GLOBAL_MEMORY );

	char* buffer = (char*)GlobalLock( clipBuffer );
	PLUGIN_CHECK_ERROR( buffer,
		GlobalFree( clipBuffer );
		CloseClipboard();
		return;,
		UNABLE_TO_LOCK_GLOBAL_DATA );
	strcpy_s( buffer, s.length() + 1, s.c_str() );
	PLUGIN_CHECK_ERROR( GlobalUnlock( clipBuffer ),
		GlobalFree( clipBuffer );
		CloseClipboard();
		return;,
		UNABLE_TO_LOCK_GLOBAL_DATA );

	PLUGIN_CHECK_ERROR( SetClipboardData( CF_TEXT, clipBuffer ),
		GlobalFree( clipBuffer );
		CloseClipboard();
		return;,
		UNABLE_TO_OPEN_CLIPBOARD );

	PLUGIN_CHECK_ERROR( !GlobalFree( clipBuffer ),
		CloseClipboard();
		return;,
		UNABLE_TO_FREE_GLOBAL_MEMORY );

	PLUGIN_CHECK_ERROR( CloseClipboard(), return;, UNABLE_TO_CLOSE_CLIPBOARD );

	Addtolist( 0, BLACK, L"OllyExt: Rip" );
}
