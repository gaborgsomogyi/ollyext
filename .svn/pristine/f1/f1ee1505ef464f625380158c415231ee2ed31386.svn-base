#include "stdafx.h"
#include "OllyExtVersion.h"
#include "OllyExtAbout.h"
#include "OllyExtIcon.h"
#include "OllyExtMenu.h"
#include "OllyExtIntegrity.h"
#include "OllyExtProtect.h"
#include "OllyExtBugfixes.h"
#include "OllyExt.h"


HINSTANCE g_instance = NULL;
static bool g_protectionApplied = false;


BOOL WINAPI DllMain( HINSTANCE new_instance, DWORD fdwReason, LPVOID lpvReserved )
{
	g_instance = new_instance;
	return TRUE;
}


extc int __cdecl ODBG2_Pluginquery( int ollydbgversion, ulong* features, wchar_t pluginname[SHORTNAME], wchar_t pluginversion[SHORTNAME] )
{
	if( ollydbgversion < 201 )
		return 0;

	versionInit();

	wcscpy_s( pluginname, SHORTNAME, PLUGIN_NAME );
	wcscpy_s( pluginversion, SHORTNAME, OLLYEXT_VERSION );

	Addtolist( 0, BLACK, g_versionStr );
	Addtolist( 0, BLACK, g_copyrightStr );

	return PLUGIN_VERSION;
}


extc int __cdecl ODBG2_Plugininit( void )
{
	aboutInit();

	iconInit();
	SendMessage( hwollymain, WM_SETICON, ICON_SMALL, (LPARAM)g_hIconSmall );
	SendMessage( hwollymain, WM_SETICON, ICON_BIG, (LPARAM)g_hIconBig );

	integrityInit();
	integritySnapshot( L"ntdll.dll" );

	protectReadOptions();

	bugfixesReadOptions();
	bugfixesApply();

	return 0;
}


extc void __cdecl ODBG2_Pluginreset( void )
{
	g_protectionApplied = false;
	protectReset();
}


extc void __cdecl ODBG2_Pluginexception( t_run* prun, t_thread* pthr, t_reg* preg )
{
	if( !g_protectionApplied &&
		!skipsystembp )
	{
		g_protectionApplied = true;
		protectApply();
	}
}


extc t_menu* __cdecl ODBG2_Pluginmenu( wchar_t* type )
{
	if( !wcscmp( type, PWM_MAIN ) )
		return g_mainMenu;
	return NULL;
};


extc void __cdecl ODBG2_Plugindestroy( void )
{
	integrityDestroy();
	iconDestroy();
	aboutDestroy();
	versionDestroy();
}
