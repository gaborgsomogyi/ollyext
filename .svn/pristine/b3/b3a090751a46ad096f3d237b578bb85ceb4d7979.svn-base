#include "stdafx.h"
#include "OllyExtDriver.h"


wchar_t* g_serviceName = L"OllyExt";
wchar_t* g_driverFile = L"OllyExt.sys";
wchar_t* g_driverPath = L"C:\\Windows\\SysWOW64\\drivers\\OllyExt.sys";
wchar_t* g_driverAccessName = L"\\\\.\\OllyExt";
HANDLE g_driver = NULL;


void driverInit( void )
{
	if( !PathFileExists( g_driverPath ) )
	{
		if( !CopyFile( g_driverFile, g_driverPath, false ) )
		{
			PLUGIN_CHECK_ERROR( false, return;, UNABLE_TO_COPY_DRIVER, g_driverPath );
		}
	}

	SC_HANDLE SCManager = OpenSCManager( NULL, NULL, SC_MANAGER_ALL_ACCESS );
	PLUGIN_CHECK_ERROR( SCManager, return;, UNABLE_TO_OPEN_SCM );

	SC_HANDLE SCService = OpenService( SCManager, g_serviceName, SERVICE_ALL_ACCESS );
	if( !SCService )
	{
		SCService = CreateService( SCManager, g_serviceName, g_serviceName, SERVICE_ALL_ACCESS,
									 SERVICE_KERNEL_DRIVER, SERVICE_DEMAND_START,
									 SERVICE_ERROR_NORMAL, g_driverPath, NULL, NULL,
									 NULL, NULL, NULL );
		PLUGIN_CHECK_ERROR( SCService, return;, UNABLE_TO_CREATE_SERVICE );
	}

	SERVICE_STATUS status;
	if( !QueryServiceStatus( SCService, &status ) )
	{
		PLUGIN_CHECK_ERROR( false, return;, UNABLE_TO_GET_SERVICE_STATUS );
	}

	if( status.dwCurrentState != SERVICE_RUNNING &&
		!StartService( SCService, 0, NULL ) )
	{
		PLUGIN_CHECK_ERROR( false, return;, UNABLE_TO_START_SERVICE, GetLastError() );
	}

	if( !CloseServiceHandle( SCService ) )
	{
		PLUGIN_CHECK_ERROR( false, return;, UNABLE_TO_CLOSE_SERVICE );
	}

	g_driver = CreateFile( g_driverAccessName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, 0 );
	PLUGIN_CHECK_ERROR( g_driver, return;, UNABLE_TO_OPEN_DRIVER );
}


void driverDestroy( void )
{
	if( g_driver )
	{
		CloseHandle( g_driver );
		g_driver = NULL;
	}

	SC_HANDLE SCManager = OpenSCManager( NULL, NULL, SC_MANAGER_ALL_ACCESS );
	PLUGIN_CHECK_ERROR( SCManager, return;, UNABLE_TO_OPEN_SCM );

	SC_HANDLE SCService = OpenService( SCManager, g_serviceName, SERVICE_ALL_ACCESS );
	PLUGIN_CHECK_ERROR( SCService, return;, UNABLE_TO_OPEN_SERVICE );

	SERVICE_STATUS status;
	if( !QueryServiceStatus( SCService, &status ) )
	{
		PLUGIN_CHECK_ERROR( false, return;, UNABLE_TO_GET_SERVICE_STATUS );
	}

	if( status.dwCurrentState == SERVICE_RUNNING &&
		!ControlService( SCService, SERVICE_CONTROL_STOP, &status ) )
	{
		PLUGIN_CHECK_ERROR( false, return;, UNABLE_TO_STOP_SERVICE );
	}
}
